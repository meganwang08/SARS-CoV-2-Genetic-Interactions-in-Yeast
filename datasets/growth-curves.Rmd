---
title: "nsp expression in yeast"
author: "Robert Reid"
date: "04/25/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)

# Plot theme
theme_set(theme_bw())
```

## Read data from a previously processed screenMill collection

```{r}
dir = 'data/images'
measurements <- screenmill::read_screenmill(dir)

```

## Check growth of controls by plate position on scanner

First filter all controls into set and remove border positions to only compare 'inner' controls

```{r}
measurements %>%
  filter(OE != 'Grid') %>%
  ggplot(aes(x=hours_growth,y=size,color=OE)) +
  geom_point(stat = "identity", shape=16, alpha = 0.2) +
  ggtitle("Raw Growth Curve of Nsp10-Nsp14") +
  ylab("Colony Size") +
  xlab("Time (hrs)") +
  ggsave('figures/raw-growth-curves.pdf', width = 6, height = 6)

```


```{r}
Controls <- 
  measurements %>%
  filter(plate_control == T) %>%
  filter(row %in% 2:7) %>%
  filter(column %in% 2:11) %>%
  mutate(
        hours_growth = round(hours_growth, digits=1)
  ) %>%
  group_by(position, hours_growth) %>%
  summarise(
    rep.mean = mean(size, trim=0.2),
    sd   = sd(size)
  )

```

Then graph by plate

```{r}
Controls %>%
  ggplot(aes(x=hours_growth, y=rep.mean, color=as.factor(position))) +
  geom_point(stat = "identity", shape=16) +
  geom_errorbar(aes(ymin=rep.mean-sd, ymax=rep.mean+sd)) +
  scale_color_viridis_d(option = "plasma") +
  labs(color = 'Plate Number') +
  ggtitle("Control Colony Size by Plate") +
  xlab("Time (hrs)") + 
  ylab("Control Colony Size") +
  ggsave('figures/control-growth-curves.pdf', width = 6, height = 6)
```

Aggregate replicate data points and plate normalize.

## Process data

```{r}
Growth <-
  measurements %>%
  filter(OE != 'Grid') %>%
  mutate(
    hours_growth = round(hours_growth, digits=1)
  ) %>%
  filter(row %in% 2:7) %>%
  filter(column %in% 2:11) %>%
  group_by(position, row, column, plasmid_id,strain_id, OE, hours_growth) %>%
  summarise(
    rep.mean = mean(size, trim=0.2),
    sd   = sd(size)
  )
```

Plot by genotype to see raw data and color by transformant number (this is number attached to 'labels')

## Graphs

```{r All}
Growth %>%
  ggplot(aes(x=hours_growth, y=rep.mean, color = OE)) +
  geom_point(stat = "identity") +
  #geom_errorbar(aes(ymin = rep.mean - sd, ymax = rep.mean + sd)) +
  ggtitle("Nsp10-Nsp14 expressed in yeast") +
  facet_wrap(~ position) +
  xlab("Time (hrs)") + 
  ylab("Query Colony Size") +
  ggsave('figures/plate-growth-curves.pdf', width = 6, height = 6)
```


Plate norm

```{r}
plate_mean <- Growth %>%
  group_by(position, plasmid_id, OE, strain_id, hours_growth) %>%
  summarise(
    plate.mean = mean(rep.mean, trim=0.2),
    plate.sd   = sd(rep.mean)
  )
```


```{r}
plate_mean %>%
  ggplot(aes(x=hours_growth, y=plate.mean, color = OE)) +
  geom_point(stat = "identity") +
  geom_errorbar(aes(ymin = plate.mean - plate.sd, ymax = plate.mean + plate.sd)) +
  ggtitle("Nsp10-Nsp14 expressed in yeast") +
  facet_wrap(~ position) + 
  xlab("Time (hrs)") + 
  ylab("Mean Query Colony Size")+
  ggsave('figures/mean-plate-growth-curves.pdf', width = 6, height = 6)
```

```{r}
plate_max_EV <- Controls %>%
  group_by(position) %>%
  summarise(
    max_EV = max(rep.mean)
  ) %>%
  select(position, max_EV)
```

```{r}
plate_norm <- plate_mean %>%
  left_join(plate_max_EV) %>%
  group_by(position, plasmid_id, OE, strain_id, hours_growth) %>%
    mutate(
      norm_mean = plate.mean/max_EV,
      norm_sd = plate.sd/max_EV
    )

```

```{r}
plate_norm %>%
  ggplot(aes(x=hours_growth, y=norm_mean, color = OE)) +
  geom_point(stat = "identity") +
  geom_errorbar(aes(ymin = norm_mean - norm_sd, ymax = norm_mean + norm_sd)) +
  ggtitle("Nsp10-Nsp14 expressed in yeast") +
  facet_wrap(~ position) +
  xlab("Time (hrs)") + 
  ylab("Normalized Query Colony Size") +
  ggsave('figures/normalized-plate-growth-curves.pdf', width = 6, height = 6)
```

Normalize the strain growth by the maximum EV colony size

```{r}
strain_mean <- Growth %>%
  left_join(plate_max_EV)%>%
    mutate(
      norm_rep = rep.mean/max_EV
    ) %>%
  group_by(strain_id, plasmid_id, OE, hours_growth) %>%
  summarise(
    strain.mean = mean(norm_rep, trim=0.2),
    strain.sd   = sd(norm_rep)
  ) %>%
mutate(mutant = case_when(
    OE %in% c('GAL10p-Nsp10 GAL1p-Nsp14', 'GAL1p-Nsp14')~ "Nsp14 Wild-Type",
    OE %in% c('GAL10p-Nsp10 GAL1p-Nsp14 exo-', 'GAL1p-Nsp14 exo-') ~ "Nsp14 exo-",
    OE %in% c('GAL10p-Nsp10 GAL1p-Nsp14 MT-', 'GAL1p-Nsp14 MT-') ~ "Nsp14 MT-",
    OE == "Gal10p-Nsp10" ~ "Nsp10",
    TRUE ~ "Empty Vector"
    ),
    complex = case_when(
    OE %in% c('GAL10p-Nsp10 GAL1p-Nsp14', 'GAL10p-Nsp10 GAL1p-Nsp14 exo-','GAL10p-Nsp10 GAL1p-Nsp14 MT-')~ "Nsp10 + Nsp14",
    OE %in% c('GAL1p-Nsp14', 'GAL1p-Nsp14 exo-','GAL1p-Nsp14 MT-')~ "Nsp14",
    OE == "Gal10p-Nsp10" ~ "Nsp10",
    TRUE ~ "Empty Vector")
      
    )
```

Split data up into three panels

```{r}
grids1 <- strain_mean %>%
  filter(OE %in% c("Empty Vector","Gal10p-Nsp10"))
grids2 <- strain_mean %>%
  filter(OE %in% c("Empty Vector","Gal10p-Nsp10"))
grids3 <- strain_mean %>%
  filter(OE %in% c("Empty Vector","Gal10p-Nsp10"))
grids1$mutant <- "Nsp14 Wild-Type"
grids2$mutant <- "Nsp14 exo-"
grids3$mutant <- "Nsp14 MT-"
strain_mean2 <- rbind(grids1, strain_mean)
strain_mean2 <- rbind(grids2, strain_mean2)
strain_mean2 <- rbind(grids3, strain_mean2) %>%
  mutate(mutant = ordered(mutant, levels = c("Nsp14 Wild-Type", "Nsp14 exo-", "Nsp14 MT-")))
```

```{r}
`%notin%` <- Negate(`%in%`)
```

```{r}
strain_mean2 %>%
  filter(mutant %notin% c(NA)) %>%
  ggplot(aes(x=hours_growth, y=strain.mean, color = complex)) +
  scale_color_manual(values=c("#F8766D", "#C77CFF", "#00BA38", "#619CFF"))+
  geom_point(stat = "identity") +
  geom_errorbar(aes(ymin = strain.mean - strain.sd, ymax = strain.mean + strain.sd), width=.5) +
  scale_fill_manual(values=c("#F8766D", "#C77CFF", "#00BA38", "#619CFF"))+
  facet_wrap(~mutant) +
  ggtitle("Nsp10-Nsp14 Separation of Function Mutants") +
  xlab("Time (hrs)") + 
  ylab("Normalized Query Colony Size") + 
  labs(color = "Complex", fill = "Complex")+
  theme(legend.position = c(0.13, 0.88), legend.key.size = unit(4.5, 'mm'))+
  ggsave('figures/normalized-strain-growth-curves-mut2.pdf', width = 6, height = 6)

```

```{r}
strain_mean %>%
  write_csv("data/strain_mean_20200812.csv")
```
Only keep empty vector, and remove mutant strains but keep nsp10 only

```{r}
strain_mean %>%
  filter(OE %in% c('Empty Vector', 'Gal10p-Nsp10', 'GAL10p-Nsp10 GAL1p-Nsp14', 'GAL1p-Nsp14')) %>%
  ggplot(aes(x=hours_growth, y=strain.mean, color = OE)) +
  geom_point(stat = "identity") +
  geom_ribbon(aes(ymin = strain.mean - strain.sd, ymax = strain.mean + strain.sd, fill=OE),alpha=0.3,color=NA) +
  ggtitle("Nsp10-Nsp14 Wildtype") +
  xlab("Time (hrs)") + 
  ylab("Normalized Query Colony Size") + 
  labs(color = "Overexpression", fill = "Overexpression")+ 
  theme(legend.position = c(0.20, 0.7))+
  ggsave('figures/normalized-strain-growth-curves-mut-empty-nsp10-nsp14WT.pdf', width = 4.5, height = 4.5)

```


```{r}
strain_mean %>%
  write_csv("data/strain_mean_20200812.csv")
```


Combine biological replicates

```{r}
final_growth <-
  plate_norm %>%
  group_by(plasmid_id, OE, hours_growth) %>%
  summarise(
    mean = mean(norm_mean),
    sd   = sd(norm_mean),
    n = n(),
    result.se = sd / sqrt(n),
    ci95 = result.se * qt(0.975, df=n-1)
  )
```


```{r}
final_growth %>%
  ggplot(aes(x=hours_growth, mean, color = OE)) +
  geom_line(stat = "identity", size=2) +
  #geom_smooth(span=0.2) +
  geom_ribbon(aes(ymin = mean - ci95, ymax = mean + ci95, fill=OE),alpha=0.3,color=NA) +
  ggtitle("Nsp14 Expression Results in Significant Growth Reduction in Yeast") +
  xlab("Time (hrs)") +
  ylab("Normalized growth") +
  ggsave('figures/overall-growth-curves.pdf', width = 6, height = 6)
```


Not yet used to produce figures
```{r}

smooth_models <- final_growth %>%
  nest(-OE) %>%
  mutate(
    m = map(data = c(plasmid_id, hours_growth, mean, sd, n, result.se, ci95),loess,
            formula = mean ~ hours_growth,span=0.3),
    fitted=map(m, `[[`,"fitted")
  )

results <- smooth_models %>%
  select(-m) %>%
  unnest()

```

```{r}
results %>%
  filter(!OE %in% c("Nsp4","Nsp1","Orf8")) %>%
  ggplot(aes(x=hours_growth, fitted, color = factor(OE,
                                                    levels = c("2µEV","EV","2µSARS2-PLP",
                                                               "SARS2-PLP","2µSARS1-PLP",
                                                               "SARS1-PLP")))) +
  geom_line(stat = "identity", size=2) +
  #geom_smooth(span=0.2) +
  geom_ribbon(aes(ymin = fitted - ci95, ymax = fitted + ci95, fill=factor(OE,
                                                    levels = c("2µEV","EV","2µSARS2-PLP",
                                                               "SARS2-PLP","2µSARS1-PLP",
                                                               "SARS1-PLP"))),alpha=0.3,color=NA) +
  ggtitle("SARS1 & SARS2 PLP fitness reduction in yeast") +
  xlab("time (hours)") +
  ylab("normalized fitness") +
  guides(fill=guide_legend(title = NULL),
         color=guide_legend(title = NULL))


```